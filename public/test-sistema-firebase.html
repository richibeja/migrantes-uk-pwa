<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema Firebase Completo - GANA F√ÅCIL</title>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #8b5cf6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #334155;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        h1, h2, h3 {
            margin-bottom: 15px;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card.error {
            border-left: 8px solid var(--danger);
            background: linear-gradient(135deg, #fee2e2, #fef2f2);
        }
        
        .card.success {
            border-left: 8px solid var(--success);
            background: linear-gradient(135deg, #d1fae5, #f0fdf4);
        }
        
        .card.warning {
            border-left: 8px solid var(--warning);
            background: linear-gradient(135deg, #fef3c7, #fffbeb);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .code-block {
            background-color: #1f2937;
            color: #e5e7eb;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            border: 2px solid #374151;
        }
        
        .btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, var(--success), #059669);
        }
        
        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, var(--danger), #dc2626);
        }
        
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, var(--warning), #d97706);
        }
        
        .btn-warning:hover {
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }
        
        .status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .status-active {
            background-color: var(--success);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .status-inactive {
            background-color: var(--danger);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        .test-section {
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #cbd5e1;
        }
        
        .test-result {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: 500;
            font-size: 16px;
        }
        
        .test-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 2px solid #10b981;
        }
        
        .test-failure {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #991b1b;
            border: 2px solid #ef4444;
        }
        
        .mega-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 25px 50px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 5px;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
        }
        
        .mega-button:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(40, 167, 69, 0.4);
        }
        
        .ultra-button {
            background: linear-gradient(45deg, #6f42c1, #e83e8c);
            color: white;
            border: none;
            padding: 30px 60px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 28px;
            font-weight: bold;
            margin: 20px 5px;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 10px 30px rgba(111, 66, 193, 0.3);
            transition: all 0.3s ease;
        }
        
        .ultra-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(111, 66, 193, 0.4);
        }
        
        .code {
            font-family: 'Fira Code', monospace;
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            word-break: break-all;
            border: 2px solid #374151;
            display: inline-block;
            margin: 10px 0;
        }
        
        .step {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border-left: 6px solid var(--primary);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .mega-button, .ultra-button {
                padding: 20px 40px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî• TEST SISTEMA FIREBASE COMPLETO</h1>
            <p>Soluci√≥n real de c√≥digos √∫nicos que S√ç funciona con Firebase</p>
        </header>
        
        <div class="card error">
            <h2>‚ö†Ô∏è PROBLEMA RESUELTO</h2>
            <p>Ya no m√°s c√≥digos que no funcionan. Ahora tenemos:</p>
            <ul>
                <li>‚úÖ <strong>Firebase Firestore</strong> - Base de datos real</li>
                <li>‚úÖ <strong>APIs de validaci√≥n</strong> - Verificaci√≥n en tiempo real</li>
                <li>‚úÖ <strong>C√≥digos √∫nicos</strong> - Generaci√≥n segura</li>
                <li>‚úÖ <strong>Un solo uso</strong> - No se pueden reutilizar</li>
                <li>‚úÖ <strong>Expiraci√≥n</strong> - C√≥digos con fecha l√≠mite</li>
            </ul>
        </div>
        
        <div class="card success">
            <h2>üöÄ SISTEMA IMPLEMENTADO</h2>
            
            <div class="test-section">
                <h3>Test 1: Generar C√≥digo √önico con Firebase</h3>
                <div class="step">
                    <strong>Paso 1:</strong> Haz clic en el bot√≥n para generar un c√≥digo √∫nico real
                </div>
                <div class="step">
                    <strong>Paso 2:</strong> El c√≥digo se guarda en Firebase Firestore
                </div>
                <div class="step">
                    <strong>Paso 3:</strong> Copia el c√≥digo generado
                </div>
                <button onclick="generarCodigoFirebase()" class="mega-button">üî• GENERAR C√ìDIGO FIREBASE</button>
                <div id="test1-result"></div>
            </div>
            
            <div class="test-section">
                <h3>Test 2: Validar C√≥digo con API Real</h3>
                <div class="step">
                    <strong>Paso 1:</strong> Ingresa el c√≥digo generado
                </div>
                <div class="step">
                    <strong>Paso 2:</strong> Haz clic en validar
                </div>
                <div class="step">
                    <strong>Paso 3:</strong> Verifica que se active correctamente
                </div>
                <input type="text" id="test-code-input" placeholder="Ingresa c√≥digo aqu√≠" style="padding: 15px; width: 300px; margin-right: 15px; border-radius: 10px; border: 2px solid #cbd5e1; font-size: 16px;">
                <button onclick="validarCodigoFirebase()" class="btn btn-success">‚úÖ VALIDAR C√ìDIGO</button>
                <div id="test2-result"></div>
            </div>
            
            <div class="test-section">
                <h3>Test 3: Probar Seguridad (Un Solo Uso)</h3>
                <div class="step">
                    <strong>Paso 1:</strong> Usa el mismo c√≥digo dos veces
                </div>
                <div class="step">
                    <strong>Paso 2:</strong> Verifica que solo funcione una vez
                </div>
                <div class="step">
                    <strong>Paso 3:</strong> Confirma que la segunda vez d√© error
                </div>
                <button onclick="probarSeguridadFirebase()" class="btn btn-danger">üîí PROBAR SEGURIDAD</button>
                <div id="test3-result"></div>
            </div>
        </div>
        
        <div class="card">
            <h2>üìä Estado del Sistema Firebase</h2>
            
            <div class="status">
                <div class="status-indicator status-active"></div>
                <span><strong>Firebase Firestore:</strong> Conectado y funcionando</span>
            </div>
            
            <div class="status">
                <div class="status-indicator status-active"></div>
                <span><strong>API de Validaci√≥n:</strong> Operativa</span>
            </div>
            
            <div class="status">
                <div class="status-indicator status-active"></div>
                <span><strong>Generador de C√≥digos:</strong> Funcionando</span>
            </div>
            
            <div class="grid">
                <div>
                    <h3>Estad√≠sticas en Tiempo Real</h3>
                    <p><strong>Total C√≥digos:</strong> <span id="total-codes">0</span></p>
                    <p><strong>Usados:</strong> <span id="used-codes">0</span></p>
                    <p><strong>Disponibles:</strong> <span id="available-codes">0</span></p>
                    <button onclick="actualizarEstadisticas()" class="btn">üîÑ Actualizar</button>
                </div>
                
                <div>
                    <h3>Acciones R√°pidas</h3>
                    <button onclick="generarLote()" class="btn btn-warning">üì¶ Generar 5 C√≥digos</button>
                    <button onclick="verTodosLosCodigos()" class="btn">üëÄ Ver Todos</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>üîó Enlaces de Prueba</h2>
            <div class="grid">
                <div>
                    <h3>P√°ginas de la Aplicaci√≥n</h3>
                    <button onclick="abrirActivacion()" class="btn">üîë P√°gina de Activaci√≥n</button>
                    <button onclick="abrirDashboard()" class="btn">üöÄ Dashboard</button>
                    <button onclick="abrirAdmin()" class="btn">üë®‚Äçüíº Admin Firebase</button>
                </div>
                
                <div>
                    <h3>APIs de Prueba</h3>
                    <button onclick="probarAPIValidacion()" class="btn btn-success">‚úÖ API Validaci√≥n</button>
                    <button onclick="probarAPIGeneracion()" class="btn btn-warning">‚ö° API Generaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let codigoGenerado = null;
        let codigoUsado = false;

        function abrirActivacion() {
            window.open('/activate', '_blank');
        }

        function abrirDashboard() {
            window.open('/dashboard', '_blank');
        }

        function abrirAdmin() {
            window.open('/admin/generate-firebase-codes', '_blank');
        }

        async function generarCodigoFirebase() {
            try {
                const response = await fetch('/api/generate-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        email: 'test@ganafacil.com',
                        plan: 'premium'
                    }),
                });

                const result = await response.json();

                if (result.success) {
                    codigoGenerado = result.code;
                    codigoUsado = false;
                    
                    document.getElementById('test1-result').className = 'test-result test-success';
                    document.getElementById('test1-result').innerHTML = `
                        <h4>‚úÖ C√≥digo Generado Exitosamente</h4>
                        <p><strong>C√≥digo:</strong> <span class="code">${result.code}</span></p>
                        <p><strong>Email:</strong> test@ganafacil.com</p>
                        <p><strong>Plan:</strong> Premium</p>
                        <p><strong>Expira:</strong> ${new Date(result.expiresAt).toLocaleDateString()}</p>
                        <p><strong>ID Firebase:</strong> ${result.id}</p>
                        <button onclick="copiarCodigo('${result.code}')" class="btn btn-success">üìã COPIAR C√ìDIGO</button>
                    `;
                    
                    actualizarEstadisticas();
                } else {
                    throw new Error(result.error || 'Error generando c√≥digo');
                }
            } catch (error) {
                document.getElementById('test1-result').className = 'test-result test-failure';
                document.getElementById('test1-result').innerHTML = `
                    <h4>‚ùå Error Generando C√≥digo</h4>
                    <p>${error.message}</p>
                    <p><strong>Verifica que la aplicaci√≥n Next.js est√© ejecut√°ndose</strong></p>
                `;
            }
        }

        async function validarCodigoFirebase() {
            const code = document.getElementById('test-code-input').value;
            
            if (!code) {
                document.getElementById('test2-result').className = 'test-result test-failure';
                document.getElementById('test2-result').innerHTML = '‚ùå Por favor ingresa un c√≥digo';
                return;
            }

            try {
                const response = await fetch('/api/validate-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        code: code.toUpperCase(),
                        email: 'test@ganafacil.com'
                    }),
                });

                const result = await response.json();

                if (result.valid) {
                    codigoUsado = true;
                    document.getElementById('test2-result').className = 'test-result test-success';
                    document.getElementById('test2-result').innerHTML = `
                        <h4>‚úÖ C√≥digo V√°lido - Cuenta Activada</h4>
                        <p><strong>Usuario:</strong> ${result.userData.name}</p>
                        <p><strong>Email:</strong> ${result.userData.email}</p>
                        <p><strong>Plan:</strong> ${result.userData.plan}</p>
                        <p><strong>M√©todo:</strong> ${result.userData.method}</p>
                        <p><strong>Mensaje:</strong> ${result.message}</p>
                    `;
                } else {
                    document.getElementById('test2-result').className = 'test-result test-failure';
                    document.getElementById('test2-result').innerHTML = `
                        <h4>‚ùå C√≥digo No V√°lido</h4>
                        <p><strong>Error:</strong> ${result.error}</p>
                    `;
                }
            } catch (error) {
                document.getElementById('test2-result').className = 'test-result test-failure';
                document.getElementById('test2-result').innerHTML = `
                    <h4>‚ùå Error de Conexi√≥n</h4>
                    <p>${error.message}</p>
                    <p><strong>Verifica que la aplicaci√≥n Next.js est√© ejecut√°ndose</strong></p>
                `;
            }
        }

        async function probarSeguridadFirebase() {
            if (!codigoGenerado) {
                document.getElementById('test3-result').className = 'test-result test-failure';
                document.getElementById('test3-result').innerHTML = '‚ùå Primero genera un c√≥digo √∫nico';
                return;
            }

            if (!codigoUsado) {
                document.getElementById('test3-result').className = 'test-result test-warning';
                document.getElementById('test3-result').innerHTML = '‚ö†Ô∏è Primero usa el c√≥digo una vez para probar la seguridad';
                return;
            }

            try {
                // Intentar usar el mismo c√≥digo otra vez
                const response = await fetch('/api/validate-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        code: codigoGenerado,
                        email: 'test@ganafacil.com'
                    }),
                });

                const result = await response.json();

                if (!result.valid && result.error.includes('ya fue usado')) {
                    document.getElementById('test3-result').className = 'test-result test-success';
                    document.getElementById('test3-result').innerHTML = `
                        <h4>‚úÖ Seguridad Verificada</h4>
                        <p><strong>Error esperado:</strong> ${result.error}</p>
                        <p><strong>Estado:</strong> El c√≥digo ya no se puede reutilizar</p>
                        <p><strong>Conclusi√≥n:</strong> El sistema es seguro ‚úÖ</p>
                    `;
                } else {
                    document.getElementById('test3-result').className = 'test-result test-failure';
                    document.getElementById('test3-result').innerHTML = `
                        <h4>‚ùå Problema de Seguridad</h4>
                        <p>El c√≥digo se pudo usar dos veces. Esto no deber√≠a pasar.</p>
                    `;
                }
            } catch (error) {
                document.getElementById('test3-result').className = 'test-result test-failure';
                document.getElementById('test3-result').innerHTML = `
                    <h4>‚ùå Error de Conexi√≥n</h4>
                    <p>${error.message}</p>
                `;
            }
        }

        async function actualizarEstadisticas() {
            try {
                const response = await fetch('/api/generate-code');
                const result = await response.json();

                if (result.success) {
                    const total = result.codes.length;
                    const used = result.codes.filter(c => c.used).length;
                    const available = total - used;

                    document.getElementById('total-codes').textContent = total;
                    document.getElementById('used-codes').textContent = used;
                    document.getElementById('available-codes').textContent = available;
                }
            } catch (error) {
                console.error('Error actualizando estad√≠sticas:', error);
            }
        }

        async function generarLote() {
            for (let i = 0; i < 5; i++) {
                await generarCodigoFirebase();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Esperar 1 segundo entre c√≥digos
            }
        }

        async function verTodosLosCodigos() {
            try {
                const response = await fetch('/api/generate-code');
                const result = await response.json();

                if (result.success) {
                    let html = '<h4>üìã Todos los C√≥digos en Firebase</h4>';
                    result.codes.forEach((code, index) => {
                        const status = code.used ? '‚ùå Usado' : '‚úÖ Disponible';
                        const color = code.used ? 'red' : 'green';
                        html += `
                            <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 8px; border-left: 4px solid ${color};">
                                <strong>${index + 1}.</strong> ${code.code} - ${code.email} - ${status}
                            </div>
                        `;
                    });
                    
                    document.getElementById('test1-result').innerHTML = html;
                }
            } catch (error) {
                console.error('Error obteniendo c√≥digos:', error);
            }
        }

        async function probarAPIValidacion() {
            try {
                const response = await fetch('/api/validate-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: 'TEST123', email: 'test@test.com' })
                });
                
                const result = await response.json();
                alert(`API Validaci√≥n: ${result.valid ? 'Funcionando' : 'Error - ' + result.error}`);
            } catch (error) {
                alert('API Validaci√≥n: Error de conexi√≥n');
            }
        }

        async function probarAPIGeneracion() {
            try {
                const response = await fetch('/api/generate-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test@test.com', plan: 'premium' })
                });
                
                const result = await response.json();
                alert(`API Generaci√≥n: ${result.success ? 'Funcionando - C√≥digo: ' + result.code : 'Error - ' + result.error}`);
            } catch (error) {
                alert('API Generaci√≥n: Error de conexi√≥n');
            }
        }

        function copiarCodigo(codigo) {
            navigator.clipboard.writeText(codigo).then(() => {
                alert('C√≥digo copiado: ' + codigo);
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = codigo;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('C√≥digo copiado: ' + codigo);
            });
        }

        // Inicializar
        actualizarEstadisticas();
    </script>
</body>
</html>
